name: Lint

on:
  push:
    branches:
      - '**'
      - '!dependabot/**'
  pull_request:

permissions:  # added using https://github.com/step-security/secure-workflows
  contents: read

jobs:
  lint:
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    # libyaml-dev is needed for psych, see https://github.com/ruby/setup-ruby/issues/409
    - if: ${{ matrix.os == 'ubuntu-latest' }}
      run: sudo apt install libyaml-dev
    - name: Set up Ruby
      uses: ruby/setup-ruby@ae195bbe749a7cef685ac729197124a48305c1cb # v1.276.0
      with:
        ruby-version: 3.3
        bundler-cache: true
    - name: Run rubocop
      run: bundle exec rubocop
    - name: Run herb linter
      # npx should be available by default so we don't need `setup-node` action
      # Don't lint erb files outside of lib as the current directory also includes vendor/bundle
      run: npx @herb-tools/linter "lib/**/*.rhtml"
    - name: Install npm dependencies
      run: npm ci
    - name: Run stylelint
      run: npm run lint:css
